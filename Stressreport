<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stress Dashboard — Live Stats</title>
<style>
  body{font-family:Arial, Helvetica, sans-serif;background:#f4f6fb;color:#111;margin:0;padding:20px;}
  h1{text-align:center;color:#11436b;margin-bottom:4px;}
  h2{color:#11436b;margin-top:24px;}
  .card{background:#fff;padding:16px;margin-bottom:16px;border-radius:12px;box-shadow:0 8px 24px rgba(8,10,20,.06);}
  table{width:100%;border-collapse:collapse;margin-top:12px;}
  th,td{border:1px solid #e6eef7;padding:8px;text-align:center;}
  th{background:#f1f7ff;}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  @media(max-width:720px){.stats-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<h1>Live Stress Dashboard</h1>

<div class="card">
  <h2>Community Stats</h2>
  <p><strong>Total Tests Submitted:</strong> <span id="totalCount">0</span></p>
  <p><strong>Distribution by Category:</strong></p>
  <ul id="distribution"></ul>
</div>

<div class="card stats-grid">
  <div>
    <h2>Average Stress by Age & Gender</h2>
    <table>
      <thead>
        <tr><th>Gender</th><th>0–18</th><th>18–25</th><th>26–35</th><th>36+</th></tr>
      </thead>
      <tbody>
        <tr><td>Male</td><td id="male-0-18">-</td><td id="male-18-25">-</td><td id="male-26-35">-</td><td id="male-36+">-</td></tr>
        <tr><td>Female</td><td id="female-0-18">-</td><td id="female-18-25">-</td><td id="female-26-35">-</td><td id="female-36+">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// --------------------
// Firebase config
// --------------------
const firebaseConfig = {
  apiKey: "AIzaSyDvYmVBsufaspOcfHNOASnhprlgxMZb8_I",
  authDomain: "stresstestdb.firebaseapp.com",
  projectId: "stresstestdb",
  storageBucket: "stresstestdb.firebasestorage.app",
  messagingSenderId: "770106837788",
  appId: "1:770106837788:web:656424276d7a20833308d9",
  measurementId: "G-NKBVWEXGD9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const collectionRef = collection(db, "stressTestResults");

// Helper to compute average
const avg = arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length)+'%' : '-';

// Load and display stats
async function loadStats(){
  const docs = await getDocs(collectionRef);
  const rows = [];
  docs.forEach(d => rows.push(d.data()));

  const total = rows.length;
  document.getElementById("totalCount").innerText = total;

  // Category distribution
  const dist = { Normal:0, Medium:0, High:0, "Very Risky":0 };
  rows.forEach(r=>{ if(r.category) dist[r.category] = (dist[r.category]||0)+1; });

  const distEl = document.getElementById("distribution");
  distEl.innerHTML = `
    <li>Normal: ${dist.Normal} (${total? Math.round(dist.Normal/total*100):0}%)</li>
    <li>Medium: ${dist.Medium} (${total? Math.round(dist.Medium/total*100):0}%)</li>
    <li>High: ${dist.High} (${total? Math.round(dist.High/total*100):0}%)</li>
    <li>Very Risky: ${dist["Very Risky"]} (${total? Math.round(dist["Very Risky"]/total*100):0}%)</li>
  `;

  // Buckets by gender & age
  const ageGroups = ["0-18","18-25","26-35","36+"];
  const buckets = { male: {"0-18":[], "18-25":[], "26-35":[], "36+": []}, female: {"0-18":[], "18-25":[], "26-35":[], "36+": []} };

  rows.forEach(r=>{
    let ag = r.ageGroup || "36+";
    if(ag==="0-18" || ag==="Below 18") ag="0-18";
    else if(ag==="18-25") ag="18-25";
    else if(ag==="26-35") ag="26-35";
    else ag="36+";
    const g = (r.gender||"").toLowerCase().startsWith("f") ? "female":"male";
    if(buckets[g] && buckets[g][ag]) buckets[g][ag].push(Number(r.percent||0));
  });

  document.getElementById("male-0-18").innerText = avg(buckets.male["0-18"]);
  document.getElementById("male-18-25").innerText = avg(buckets.male["18-25"]);
  document.getElementById("male-26-35").innerText = avg(buckets.male["26-35"]);
  document.getElementById("male-36+").innerText = avg(buckets.male["36+"]);

  document.getElementById("female-0-18").innerText = avg(buckets.female["0-18"]);
  document.getElementById("female-18-25").innerText = avg(buckets.female["18-25"]);
  document.getElementById("female-26-35").innerText = avg(buckets.female["26-35"]);
  document.getElementById("female-36+").innerText = avg(buckets.female["36+"]);
}

// Initial load
loadStats();
</script>
</body>
</html>
